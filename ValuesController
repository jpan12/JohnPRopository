using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Mvc;

namespace GroceryStoreAPI.Controllers
{  
    [Route("api/[controller]")]
    [ApiController]
    public class ValuesController : ControllerBase
    {
    //test only    
    private readonly IJDataProvider _jdataProviderr; 
    public ValuesController(IJDataProvider jdataProvider)
    {
      _jdataProviderr=jdataProviderr
    }
//properties
    public string Type { get; set; }   
    public string newValue { get; set; }
    public int Id { get; set; }
    public string Result { get; set; } 
//test above only




//variables
string filepath = "../database.json";
Var JData = new StreamReader(filepath).ReadToEnd()// load j data from j file
JObject jObjs = JObject.Parse(JData);


        // GET api/values search based on type such as customer, product, and order for a customer
        [HttpGet("{Type}")]
        public ActionResult<IEnumerable<string>> Get(string Type)
        {
	
          char[] charsToTrim = {',', ' '};
           var returnValue= string.empty;
 	        switch(Type)
	        {
	          case "customers"
		      var names = jObjs["customers"].Children()["name"];
	            var list = new List<string>();
	            list.AddRange(names.Select(name => names.Value<string>()));
	            foreach (var item in list)
	              returnValue += "\"" + item +"\","
                //finale format should be "pan","jonh"
	            break;
	          case "products"
	            var products = jObjs["products"].Children();
              foreach (var item in products {
              returnValue += "\"" + item[desription] +" " +item[price] + "\","  
            //finale format should be "TV 300.0","table 56.7"
	            break;
	       
          default:
	        }
          return (returnValue.TrimEnd(charsToTrim)
           // return new string[] { "value1", "value2" };
        }

        // GET api/values/5 
        [HttpGet("{id}/{Type}")]
        public ActionResult<string> Get(int id, string Type)
        {        
          var returnValue= string.empty;
 	        switch(Type)
	        {
	          case "customers"
             		returnValue =GetCustomersById(Id)	 
	            break;
	          case "products"
             		 returnValue = GetProductsById(Id)   
	            break;
          	 case "orders" //get orders for one customer
	          var orders = jObjs["orders"].Children();
           	 foreach (var item in orders {
             		 var name =GetCustomersById(item["customerId"])
		          if item["customerId"]==Id
		          {
            	    var items = tem["items"].Children();
		              foreach (var itm in items {
			            returnValue += "\"" + GetProductsById(itm["productId"]) +" " +itm["quantity"] + "\","  
		              }           	
	            }		
            }
          
             //finale format should be   "TV 3","table 2"
          break;
              default:
	          }
          return (returnValue.TrimEnd(charsToTrim)
            //return "value";
        }

        // POST api/values  var JData = {Type:"customers" Id:1, Name:"James" }
        [HttpPost]
        public string Post([FromBody] JData value)
        { 
	string type= value["Type"];
	try{
          string filepath = "../database.json";
          switch(type)
          {
	      case"customers"
 	       using (StreamReader r = new StreamReader(filepath))
              {
                var json = r.ReadToEnd();
                var jobj = JObject.Parse(json);  
		         
 		var newId = max(jobj["customers"]["Id"])) + 1;
		var newCust= { Id:newId, name:value["name"]}
 		 jobj[customers]).Add(newCust)		
		}

                result = jobj.ToString();
                File.WriteAllText(filepath, result);              
            
	       break;
           case "products"
              using (StreamReader r = new StreamReader(filepath))
              {
                var json = r.ReadToEnd();
                var jobj = JObject.Parse(json);  
		
 		var newId = max(jobj["products"]["Id"])) + 1;
		var newJprod= { Id:newId, description:value["description"],price:value["price"]}
 		 jobj[products].Add(newprod)
		 }

                result = jobj.ToString();
                File.WriteAllText(filepath, result);              
	      break;
	     default:
            }  //switch    
	return "success"
 	}//try
	catch (Exception ex)
 	{
 	}
       }

        // PUT api/values/5 var JData = {Type:"customers", Id:1, name:"James" } for customer
	// JData = { Id:1, description:"good", price:23 } for product
        [HttpPut("{id}")]
        public string Put(int id, [FromBody] JData value)
        {
	string type= value["Type"];
	try{
          string filepath = "../database.json";
         
          switch(type)
          {
	      case"customers"
 	       using (StreamReader r = new StreamReader(filepath))
              {
                var json = r.ReadToEnd();
                var jobj = JObject.Parse(json);  
                foreach (var item in jobj[customers]) {
                if(item["id"] == value{"id"])
		 tem["name"] = value["name"];                           
                  }
	      }

                result = jobj.ToString();
                File.WriteAllText(filepath, result);              
            
	        break;
           	case "products"
   
              using (StreamReader r = new StreamReader(filepath))
              {
                var json = r.ReadToEnd();
                var jobj = JObject.Parse(json);  
		  
                  foreach (var item in jobj[products]) {
                  	if(item["id"] == value["id"])
                       {
			item["description"]=value["description"];
                       item["price"]=value["price"];
                      }             
                   }
		 }

                result = jobj.ToString();
                File.WriteAllText(filepath, result);              
	         break;
		default:
            }  //switch    
	return "success"
 	}//try
	catch (Exception ex)
 	{
 	}
        }//end

        // DELETE api/values/5
        [HttpDelete("{id}/{Type}")]
        public string Delete(int id, string Type)
        {
	try{
	 string filepath = "../database.json";
	  using (StreamReader r = new StreamReader(filepath))
          {
                var json = r.ReadToEnd();
                var jobj = JObject.Parse(json);
		var indx  = 0
          	switch(type)
          	{
		      case"customers"     
			 foreach (var item in jobj[customers]) {
                  	 if(item["id"] == id)
                         {
			 (jobj.customers as JArray).RemoveAt(indx);
			 break;
			 }
		         indx +=1
			
                        } //for  
			break;
			 case"products"     
			 foreach (var item in jobj[products]) {
                  	 if(item["id"] == id)
                         {
			 (jobj.products as JArray).RemoveAt(indx);
			 break;
			 }
		         indx +=1
			
                        } //for  
			break;
			default:
                   }
 			 	
		result = jobj.ToString();
                File.WriteAllText(filepath, result);                   
	      
		]//u
		retturn "success";
               }
	      catch (Exception ex)
 		{
 		}
        }
        
        //pan  /help functions********************************
        private string GetProductsById(int id)
        {
	        string returnValue=string.empty;
	        var products = jObjs["products"].Children();
	        foreach (var item in products {
             if item["Id"]==id 
             //returnValue = "\"" + item["desription"] +" " +item["price"] + "\","  
 		        returnValue = "\"" + item["desription"]  + "\","  
            }
	        return returnValue
        }
        private string GetCustomersById(int id)
        {
	        string returnValue=string.empty;
	        var names = jObjs["customers"].Children();
	        foreach (var item in names {
             if item["Id"]==id 
             returnValue = "\"" + item["name"] + "\","  
	        }
	        return returnValue
        }
    }
}
